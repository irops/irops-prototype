{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Application-Engine-Roles Template. This is a layer in the Engine application, which creates the Roles and attached Policies. This Template uses Conditions to avoid granting unnecessary permissions.",

  "Metadata" : {
    "AWS::CloudFormation::Interface" : {
      "ParameterGroups" : [
        {
          "Label" : { "default" : "Stack Dependencies" },
          "Parameters" : [
            "StandardBucketsStackName"
          ]
        },
        {
          "Label" : { "default" : "Application Dependencies Configuration" },
          "Parameters" : [
            "ProductFolder",
            "CalculationProductObject",
            "MongoDBProductObject",
            "RabbitMQProductObject",
            "DataStagingProductObject",
            "LoggingProductObject",
            "PublishingProductObject",
            "ConfigurationFolder",
            "WebConfigurationObject",
            "CalculationConfigurationObject",
            "MongoDBConfigurationObject",
            "RabbitMQConfigurationObject",
            "DataStagingConfigurationObject",
            "LoggingConfigurationObject",
            "PublishingConfigurationObject"
          ]
        },
        {
          "Label" : { "default" : "Application Configuration" },
          "Parameters" : [
            "ApplicationFolder",
            "WebApplicationObject",
            "CalculationApplicationObject",
            "MongoDBApplicationObject",
            "RabbitMQApplicationObject",
            "DataStagingApplicationObject",
            "LoggingApplicationObject",
            "PublishingApplicationObject",
            "ApplicationName",
            "LogRetention"
          ]
        }
      ],

      "ParameterLabels" : {
        "StandardBucketsStackName" : { "default" : "StandardBuckets Stack Name" },
        "ProductFolder" : { "default" : "Product Folder" },
        "CalculationProductObject" : { "default" : "Calculation Product Object" },
        "MongoDBProductObject" : { "default" : "MongoDB Product Object" },
        "RabbitMQProductObject" : { "default" : "RabbitMQ Product Object" },
        "DataStagingProductObject" : { "default" : "DataStaging Product Object" },
        "LoggingProductObject" : { "default" : "Logging Product Object" },
        "PublishingProductObject" : { "default" : "Publishing Product Object" },
        "ConfigurationFolder" : { "default" : "Configuration Folder" },
        "WebConfigurationObject" : { "default" : "Web Configuration Object" },
        "CalculationConfigurationObject" : { "default" : "Calculation Configuration Object" },
        "MongoDBConfigurationObject" : { "default" : "MongoDB Configuration Object" },
        "RabbitMQConfigurationObject" : { "default" : "RabbitMQ Configuration Object" },
        "DataStagingConfigurationObject" : { "default" : "DataStaging Configuration Object" },
        "LoggingConfigurationObject" : { "default" : "Logging Configuration Object" },
        "PublishingConfigurationObject" : { "default" : "Publishing Configuration Object" },
        "ApplicationFolder" : { "default" : "Application Folder" },
        "WebApplicationObject" : { "default" : "Web Application Object" },
        "CalculationApplicationObject" : { "default" : "Calculation Application Object" },
        "MongoDBApplicationObject" : { "default" : "MongoDB Application Object" },
        "RabbitMQApplicationObject" : { "default" : "RabbitMQ Application Object" },
        "DataStagingApplicationObject" : { "default" : "DataStaging Application Object" },
        "LoggingApplicationObject" : { "default" : "Logging Application Object" },
        "PublishingApplicationObject" : { "default" : "Publishing Application Object" },
        "ApplicationName" : { "default" : "Application Name" },
        "LogRetention" : { "default" : "Log Retention" }
      }
    }
  },

  "Parameters" : {
    "StandardBucketsStackName" : {
      "Description" : "Name of the CloudFormation Stack containing Standard Buckets",
      "Type" : "String",
      "MinLength" : 2,
      "MaxLength" : 64,
      "Default" : "StandardBuckets",
      "AllowedPattern" : "^[A-Z][-a-zA-Z0-9]*$",
      "ConstraintDescription" : "must begin with an upper case letter and contain alphanumeric characters and dashes."
    },

    "ProductFolder" : {
      "Description" : "Folder within the S3 Products bucket containing Products deployed by this Template",
      "Type" : "String",
      "MinLength" : 2,
      "MaxLength" : 32,
      "Default" : "Engine",
      "AllowedPattern" : "^[A-Z][a-zA-Z0-9]*$",
      "ConstraintDescription" : "must begin with an upper case letter and contain alphanumeric characters."
    },

    "CalculationProductObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Calculation Component installer",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "MongoDBProductObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine MongoDB Component installer",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "RabbitMQProductObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine RabbitMQ Component installer",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "DataStagingProductObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine DataStaging Component installer",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "LoggingProductObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Logging Component installer",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "PublishingProductObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Publishing Component installer",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "ConfigurationFolder" : {
      "Description" : "Folder within the S3 Configurations bucket containing Configurations deployed by this Template",
      "Type" : "String",
      "MinLength" : 2,
      "MaxLength" : 32,
      "Default" : "Engine",
      "AllowedPattern" : "^[A-Z][a-zA-Z0-9]*$",
      "ConstraintDescription" : "must begin with an upper case letter and contain alphanumeric characters."
    },

    "WebConfigurationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Web Component configuration",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "CalculationConfigurationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Calculation Component configuration",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "MongoDBConfigurationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine MongoDB Component configuration",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "RabbitMQConfigurationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine RabbitMQ Component configuration",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "DataStagingConfigurationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine DataStaging Component configuration",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "LoggingConfigurationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Logging Component configuration",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "PublishingConfigurationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Publishing Component configuration",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "ApplicationFolder" : {
      "Description" : "Folder within the S3 Applications bucket containing Applications deployed by this Template",
      "Type" : "String",
      "MinLength" : 2,
      "MaxLength" : 32,
      "Default" : "Engine",
      "AllowedPattern" : "^[A-Z][a-zA-Z0-9]*$",
      "ConstraintDescription" : "must begin with an upper case letter and contain alphanumeric characters."
    },

    "WebApplicationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Web Component application",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "CalculationApplicationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Calculation Component application",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "MongoDBApplicationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine MongoDB Component application",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "RabbitMQApplicationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine RabbitMQ Component application",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "DataStagingApplicationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine DataStaging Component application",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "LoggingApplicationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Logging Component application",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "PublishingApplicationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Publishing Component application",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "ApplicationName" : {
      "Description" : "Name of the Application associated with the Stack",
      "Type" : "String",
      "MinLength" : 2,
      "MaxLength" : 32,
      "Default" : "Engine",
      "AllowedPattern" : "^[A-Z][a-zA-Z0-9]*$",
      "ConstraintDescription" : "must begin with an upper case letter and contain alphanumeric characters."
    },

    "LogRetention" : {
      "Description" : "Number of days to retain CloudWatch Log Events (0 disables use of CloudWatch Logs)",
      "Type" : "Number",
      "Default" : 14,
      "AllowedValues" : [ 0, 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653 ],
      "ConstraintDescription" : "must be: 0 (disabled), 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827 or 3653."
    }
  },

  "Conditions" : {
    "InstallCalculationProduct" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "CalculationProductObject" }, "" ]}]},
    "InstallMongoDBProduct" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "MongoDBProductObject" }, "" ]}]},
    "InstallRabbitMQProduct" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "RabbitMQProductObject" }, "" ]}]},
    "InstallDataStagingProduct" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "DataStagingProductObject" }, "" ]}]},
    "InstallLoggingProduct" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "LoggingProductObject" }, "" ]}]},
    "InstallPublishingProduct" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "PublishingProductObject" }, "" ]}]},
    "InstallProduct" : { "Fn::Or" : [{ "Condition" : "InstallCalculationProduct" },
                                     { "Condition" : "InstallMongoDBProduct" },
                                     { "Condition" : "InstallRabbitMQProduct" },
                                     { "Condition" : "InstallDataStagingProduct" },
                                     { "Condition" : "InstallLoggingProduct" },
                                     { "Condition" : "InstallPublishingProduct" }]},
    "InstallWebConfiguration" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "WebConfigurationObject" }, "" ]}]},
    "InstallCalculationConfiguration" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "CalculationConfigurationObject" }, "" ]}]},
    "InstallMongoDBConfiguration" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "MongoDBConfigurationObject" }, "" ]}]},
    "InstallRabbitMQConfiguration" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "RabbitMQConfigurationObject" }, "" ]}]},
    "InstallDataStagingConfiguration" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "DataStagingConfigurationObject" }, "" ]}]},
    "InstallLoggingConfiguration" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "LoggingConfigurationObject" }, "" ]}]},
    "InstallPublishingConfiguration" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "PublishingConfigurationObject" }, "" ]}]},
    "InstallConfiguration" : { "Fn::Or" : [{ "Condition" : "InstallWebConfiguration" },
                                           { "Condition" : "InstallCalculationConfiguration" },
                                           { "Condition" : "InstallMongoDBConfiguration" },
                                           { "Condition" : "InstallRabbitMQConfiguration" },
                                           { "Condition" : "InstallDataStagingConfiguration" },
                                           { "Condition" : "InstallLoggingConfiguration" },
                                           { "Condition" : "InstallPublishingConfiguration" }]},
    "InstallWebApplication" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "WebApplicationObject" }, "" ]}]},
    "InstallCalculationApplication" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "CalculationApplicationObject" }, "" ]}]},
    "InstallMongoDBApplication" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "MongoDBApplicationObject" }, "" ]}]},
    "InstallRabbitMQApplication" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "RabbitMQApplicationObject" }, "" ]}]},
    "InstallDataStagingApplication" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "DataStagingApplicationObject" }, "" ]}]},
    "InstallLoggingApplication" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "LoggingApplicationObject" }, "" ]}]},
    "InstallPublishingApplication" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "PublishingApplicationObject" }, "" ]}]},
    "InstallApplication" : { "Fn::Or" : [{ "Condition" : "InstallWebApplication" },
                                         { "Condition" : "InstallCalculationApplication" },
                                         { "Condition" : "InstallMongoDBApplication" },
                                         { "Condition" : "InstallRabbitMQApplication" },
                                         { "Condition" : "InstallDataStagingApplication" },
                                         { "Condition" : "InstallLoggingApplication" },
                                         { "Condition" : "InstallPublishingApplication" }]},
    "ConfigureLogs" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "LogRetention" }, "0" ]}]}
  },

  "Resources" : {
    "WebRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Principal" : { "Service" : [ "ec2.amazonaws.com" ]},
            "Action" : [ "sts:AssumeRole" ]
          }]
        },
        "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ]
      }
    },

    "CalculationRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Principal" : { "Service" : [ "ec2.amazonaws.com" ]},
            "Action" : [ "sts:AssumeRole" ]
          }]
        },
        "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ]
      }
    },

    "MongoDBRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Principal" : { "Service" : [ "ec2.amazonaws.com" ]},
            "Action" : [ "sts:AssumeRole" ]
          }]
        },
        "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ]
      }
    },

    "RabbitMQRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Principal" : { "Service" : [ "ec2.amazonaws.com" ]},
            "Action" : [ "sts:AssumeRole" ]
          }]
        },
        "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ]
      }
    },

    "DataStagingRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Principal" : { "Service" : [ "ec2.amazonaws.com" ]},
            "Action" : [ "sts:AssumeRole" ]
          }]
        },
        "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ]
      }
    },

    "LoggingRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Principal" : { "Service" : [ "ec2.amazonaws.com" ]},
            "Action" : [ "sts:AssumeRole" ]
          }]
        },
        "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ]
      }
    },

    "PublishingRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Principal" : { "Service" : [ "ec2.amazonaws.com" ]},
            "Action" : [ "sts:AssumeRole" ]
          }]
        },
        "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ]
      }
    },

    "DownloadProductFromS3Policy" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyName" : "DownloadProductFromS3Policy",
        "PolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Action" : [
              "s3:GetObject"
            ],
            "Resource" : { "Fn::Join" : [ "", [ "arn:aws:s3:::",  { "Fn::ImportValue" : { "Fn::Sub" : "${StandardBucketsStackName}-ProductsBucket" }}, "/", { "Ref" : "ProductFolder" }, "/*" ]]}
          }]
        },
        "Roles" : [
          { "Fn::If" : [ "InstallCalculationProduct", { "Ref" : "CalculationRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallMongoDBProduct", { "Ref" : "MongoDBRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallRabbitMQProduct", { "Ref" : "RabbitMQRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallDataStagingProduct", { "Ref" : "DataStagingRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallLoggingProduct", { "Ref" : "LoggingRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallPublishingProduct", { "Ref" : "PublishingRole" }, { "Ref": "AWS::NoValue" }]}
        ]
      },
      "Condition" : "InstallProduct"
    },

    "DownloadConfigurationFromS3Policy" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyName" : "DownloadConfigurationFromS3Policy",
        "PolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Action" : [
              "s3:GetObject"
            ],
            "Resource" : { "Fn::Join" : [ "", [ "arn:aws:s3:::",  { "Fn::ImportValue" : { "Fn::Sub" : "${StandardBucketsStackName}-ConfigurationsBucket" }}, "/", { "Ref" : "ConfigurationFolder" }, "/*" ]]}
          }]
        },
        "Roles" : [
          { "Fn::If" : [ "InstallWebConfiguration", { "Ref" : "WebRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallCalculationConfiguration", { "Ref" : "CalculationRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallMongoDBConfiguration", { "Ref" : "MongoDBRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallRabbitMQConfiguration", { "Ref" : "RabbitMQRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallDataStagingConfiguration", { "Ref" : "DataStagingRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallLoggingConfiguration", { "Ref" : "LoggingRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallPublishingConfiguration", { "Ref" : "PublishingRole" }, { "Ref": "AWS::NoValue" }]}
        ]
      },
      "Condition" : "InstallConfiguration"
    },

    "DownloadApplicationFromS3Policy" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyName" : "DownloadApplicationFromS3Policy",
        "PolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Action" : [
              "s3:GetObject"
            ],
            "Resource" : { "Fn::Join" : [ "", [ "arn:aws:s3:::",  { "Fn::ImportValue" : { "Fn::Sub" : "${StandardBucketsStackName}-ApplicationsBucket" }}, "/", { "Ref" : "ApplicationFolder" }, "/*" ]]}
          }]
        },
        "Roles" : [
          { "Fn::If" : [ "InstallWebApplication", { "Ref" : "WebRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallCalculationApplication", { "Ref" : "CalculationRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallMongoDBApplication", { "Ref" : "MongoDBRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallRabbitMQApplication", { "Ref" : "RabbitMQRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallDataStagingApplication", { "Ref" : "DataStagingRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallLoggingApplication", { "Ref" : "LoggingRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallPublishingApplication", { "Ref" : "PublishingRole" }, { "Ref": "AWS::NoValue" }]}
        ]
      },
      "Condition" : "InstallApplication"
    },

    "LogMonitoringPolicy" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyName" : "LogMonitoringPolicy",
        "PolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Action" : [
              "logs:CreateLogGroup",
              "logs:CreateLogStream",
              "logs:PutLogEvents",
              "logs:DescribeLogStreams"
            ],
            "Resource" : "arn:aws:logs:*:*:*"
          }]
        },
        "Roles" : [
          { "Ref" : "WebRole" },
          { "Ref" : "CalculationRole" },
          { "Ref" : "MongoDBRole" },
          { "Ref" : "RabbitMQRole" },
          { "Ref" : "DataStagingRole" },
          { "Ref" : "LoggingRole" },
          { "Ref" : "PublishingRole" }
        ]
      },
      "Condition" : "ConfigureLogs"
    }
  },

  "Outputs" : {
    "WebRole" : {
      "Description" : "The WebRole",
      "Value" : { "Ref" : "WebRole" }
    },

    "CalculationRole" : {
      "Description" : "The CalculationRole",
      "Value" : { "Ref" : "CalculationRole" }
    },

    "MongoDBRole" : {
      "Description" : "The MongoDBRole",
      "Value" : { "Ref" : "MongoDBRole" }
    },

    "RabbitMQRole" : {
      "Description" : "The RabbitMQRole",
      "Value" : { "Ref" : "RabbitMQRole" }
    },

    "DataStagingRole" : {
      "Description" : "The DataStagingRole",
      "Value" : { "Ref" : "DataStagingRole" }
    },

    "LoggingRole" : {
      "Description" : "The LoggingRole",
      "Value" : { "Ref" : "LoggingRole" }
    },

    "PublishingRole" : {
      "Description" : "The PublishingRole",
      "Value" : { "Ref" : "PublishingRole" }
    }
  }
}
