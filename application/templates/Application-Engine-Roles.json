{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Application-Engine-Roles Template. This is a layer in the Engine application, which creates the Roles and attached Policies. This Template uses Conditions to avoid granting unnecessary permissions.",

  "Metadata" : {
    "AWS::CloudFormation::Interface" : {
      "ParameterGroups" : [
        {
          "Label" : { "default" : "Application Dependencies Configuration" },
          "Parameters" : [
            "ProductsBucket",
            "ProductFolder",
            "CalculationProductObject",
            "MongoDBProductObject",
            "RabbitMQProductObject",
            "DataStagingProductObject",
            "LoggingProductObject",
            "DeploymentProductObject",
            "PublishProductObject",
            "ConfigurationsBucket",
            "ConfigurationFolder",
            "WebConfigurationObject",
            "CalculationConfigurationObject",
            "MongoDBConfigurationObject",
            "RabbitMQConfigurationObject",
            "DataStagingConfigurationObject",
            "LoggingConfigurationObject",
            "DeploymentConfigurationObject",
            "PublishConfigurationObject"
          ]
        },
        {
          "Label" : { "default" : "Application Configuration" },
          "Parameters" : [
            "ApplicationsBucket",
            "ApplicationFolder",
            "WebApplicationObject",
            "CalculationApplicationObject",
            "MongoDBApplicationObject",
            "RabbitMQApplicationObject",
            "DataStagingApplicationObject",
            "LoggingApplicationObject",
            "DeploymentApplicationObject",
            "PublishApplicationObject",
            "ApplicationName",
            "LogRetention"
          ]
        }
      ],

      "ParameterLabels" : {
        "ProductsBucket" : { "default" : "Products Bucket" },
        "ProductFolder" : { "default" : "Product Folder" },
        "CalculationProductObject" : { "default" : "Calculation Product Object" },
        "MongoDBProductObject" : { "default" : "MongoDB Product Object" },
        "RabbitMQProductObject" : { "default" : "RabbitMQ Product Object" },
        "DataStagingProductObject" : { "default" : "DataStaging Product Object" },
        "LoggingProductObject" : { "default" : "Logging Product Object" },
        "DeploymentProductObject" : { "default" : "Deployment Product Object" },
        "PublishProductObject" : { "default" : "Publish Product Object" },
        "ConfigurationsBucket" : { "default" : "Configurations Bucket" },
        "ConfigurationFolder" : { "default" : "Configuration Folder" },
        "WebConfigurationObject" : { "default" : "Web Configuration Object" },
        "CalculationConfigurationObject" : { "default" : "Calculation Configuration Object" },
        "MongoDBConfigurationObject" : { "default" : "MongoDB Configuration Object" },
        "RabbitMQConfigurationObject" : { "default" : "RabbitMQ Configuration Object" },
        "DataStagingConfigurationObject" : { "default" : "DataStaging Configuration Object" },
        "LoggingConfigurationObject" : { "default" : "Logging Configuration Object" },
        "DeploymentConfigurationObject" : { "default" : "Deployment Configuration Object" },
        "PublishConfigurationObject" : { "default" : "Publish Configuration Object" },
        "ApplicationsBucket" : { "default" : "Applications Bucket" },
        "ApplicationFolder" : { "default" : "Application Folder" },
        "WebApplicationObject" : { "default" : "Web Application Object" },
        "CalculationApplicationObject" : { "default" : "Calculation Application Object" },
        "MongoDBApplicationObject" : { "default" : "MongoDB Application Object" },
        "RabbitMQApplicationObject" : { "default" : "RabbitMQ Application Object" },
        "DataStagingApplicationObject" : { "default" : "DataStaging Application Object" },
        "LoggingApplicationObject" : { "default" : "Logging Application Object" },
        "DeploymentApplicationObject" : { "default" : "Deployment Application Object" },
        "PublishApplicationObject" : { "default" : "Publish Application Object" },
        "ApplicationName" : { "default" : "Application Name" },
        "LogRetention" : { "default" : "Log Retention" }
      }
    }
  },

  "Parameters" : {
    "ProductsBucket" : {
      "Description" : "S3 bucket containing 3rd-Party Products to be deployed",
      "Type" : "String",
      "MinLength" : 2,
      "MaxLength" : 64,
      "Default" : "products-us-west-2-production",
      "AllowedPattern" : "^[a-z][-a-z0-9]*$",
      "ConstraintDescription" : "must begin with a lower case letter and contain only lower case letters, numbers and dashes."
    },

    "ProductFolder" : {
      "Description" : "Folder within the S3 bucket containing Products deployed by this Template",
      "Type" : "String",
      "MinLength" : 2,
      "MaxLength" : 32,
      "Default" : "Engine",
      "AllowedPattern" : "^[A-Z][a-zA-Z0-9]*$",
      "ConstraintDescription" : "must begin with an upper case letter and contain alphanumeric characters."
    },

    "CalculationProductObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Calculation Component installer",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "MongoDBProductObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine MongoDB Component installer",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "RabbitMQProductObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine RabbitMQ Component installer",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "DataStagingProductObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine DataStaging Component installer",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "LoggingProductObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Logging Component installer",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "DeploymentProductObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Deployment Component installer",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "PublishProductObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Publish Component installer",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "ConfigurationsBucket" : {
      "Description" : "S3 bucket containing Configurations to be deployed",
      "Type" : "String",
      "MinLength" : 2,
      "MaxLength" : 64,
      "Default" : "configurations-us-west-2-irops",
      "AllowedPattern" : "^[a-z][-a-z0-9]*$",
      "ConstraintDescription" : "must begin with a lower case letter and contain only lower case letters, numbers and dashes."
    },

    "ConfigurationFolder" : {
      "Description" : "Folder within the S3 bucket containing Configurations deployed by this Template",
      "Type" : "String",
      "MinLength" : 2,
      "MaxLength" : 32,
      "Default" : "Engine",
      "AllowedPattern" : "^[A-Z][a-zA-Z0-9]*$",
      "ConstraintDescription" : "must begin with an upper case letter and contain alphanumeric characters."
    },

    "WebConfigurationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Web Component configuration",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "CalculationConfigurationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Calculation Component configuration",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "MongoDBConfigurationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine MongoDB Component configuration",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "RabbitMQConfigurationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine RabbitMQ Component configuration",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "DataStagingConfigurationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine DataStaging Component configuration",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "LoggingConfigurationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Logging Component configuration",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "DeploymentConfigurationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Deployment Component configuration",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "PublishConfigurationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Publish Component configuration",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "ApplicationsBucket" : {
      "Description" : "S3 bucket containing Applications to be deployed",
      "Type" : "String",
      "MinLength" : 2,
      "MaxLength" : 64,
      "Default" : "applications-us-west-2-irops",
      "AllowedPattern" : "^[a-z][-a-z0-9]*$",
      "ConstraintDescription" : "must begin with a lower case letter and contain only lower case letters, numbers and dashes."
    },

    "ApplicationFolder" : {
      "Description" : "Folder within the S3 bucket containing Applications deployed by this Template",
      "Type" : "String",
      "MinLength" : 2,
      "MaxLength" : 32,
      "Default" : "Engine",
      "AllowedPattern" : "^[A-Z][a-zA-Z0-9]*$",
      "ConstraintDescription" : "must begin with an upper case letter and contain alphanumeric characters."
    },

    "WebApplicationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Web Component application",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "CalculationApplicationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Calculation Component application",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "MongoDBApplicationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine MongoDB Component application",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "RabbitMQApplicationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine RabbitMQ Component application",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "DataStagingApplicationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine DataStaging Component application",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "LoggingApplicationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Logging Component application",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "DeploymentApplicationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Deployment Component application",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "PublishApplicationObject" : {
      "Description" : "Object within the S3 bucket and folder containing the Engine Publish Component application",
      "Type" : "String",
      "MaxLength" : 64,
      "Default" : "",
      "AllowedPattern" : "(^$|^[-_.a-zA-Z0-9]*$)",
      "ConstraintDescription" : "must be a valid filename, not containing slashes."
    },

    "ApplicationName" : {
      "Description" : "Name of the Application associated with the Stack",
      "Type" : "String",
      "MinLength" : 2,
      "MaxLength" : 32,
      "Default" : "Engine",
      "AllowedPattern" : "^[A-Z][a-zA-Z0-9]*$",
      "ConstraintDescription" : "must begin with an upper case letter and contain alphanumeric characters."
    },

    "LogRetention" : {
      "Description" : "Number of days to retain CloudWatch Log Events (0 disables use of CloudWatch Logs)",
      "Type" : "Number",
      "Default" : 14,
      "AllowedValues" : [ 0, 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827, 3653 ],
      "ConstraintDescription" : "must be: 0 (disabled), 1, 3, 5, 7, 14, 30, 60, 90, 120, 150, 180, 365, 400, 545, 731, 1827 or 3653."
    }
  },

  "Conditions" : {
    "InstallCalculationProduct" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "CalculationProductObject" }, "" ]}]},
    "InstallMongoDBProduct" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "MongoDBProductObject" }, "" ]}]},
    "InstallRabbitMQProduct" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "RabbitMQProductObject" }, "" ]}]},
    "InstallDataStagingProduct" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "DataStagingProductObject" }, "" ]}]},
    "InstallLoggingProduct" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "LoggingProductObject" }, "" ]}]},
    "InstallDeploymentProduct" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "DeploymentProductObject" }, "" ]}]},
    "InstallPublishProduct" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "PublishProductObject" }, "" ]}]},
    "InstallProduct" : { "Fn::Or" : [{ "Condition" : "InstallCalculationProduct" },
                                     { "Condition" : "InstallMongoDBProduct" },
                                     { "Condition" : "InstallRabbitMQProduct" },
                                     { "Condition" : "InstallDataStagingProduct" },
                                     { "Condition" : "InstallLoggingProduct" },
                                     { "Condition" : "InstallDeploymentProduct" },
                                     { "Condition" : "InstallPublishProduct" }]},
    "InstallWebConfiguration" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "WebConfigurationObject" }, "" ]}]},
    "InstallCalculationConfiguration" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "CalculationConfigurationObject" }, "" ]}]},
    "InstallMongoDBConfiguration" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "MongoDBConfigurationObject" }, "" ]}]},
    "InstallRabbitMQConfiguration" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "RabbitMQConfigurationObject" }, "" ]}]},
    "InstallDataStagingConfiguration" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "DataStagingConfigurationObject" }, "" ]}]},
    "InstallLoggingConfiguration" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "LoggingConfigurationObject" }, "" ]}]},
    "InstallDeploymentConfiguration" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "DeploymentConfigurationObject" }, "" ]}]},
    "InstallPublishConfiguration" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "PublishConfigurationObject" }, "" ]}]},
    "InstallConfiguration" : { "Fn::Or" : [{ "Condition" : "InstallWebConfiguration" },
                                           { "Condition" : "InstallCalculationConfiguration" },
                                           { "Condition" : "InstallMongoDBConfiguration" },
                                           { "Condition" : "InstallRabbitMQConfiguration" },
                                           { "Condition" : "InstallDataStagingConfiguration" },
                                           { "Condition" : "InstallLoggingConfiguration" },
                                           { "Condition" : "InstallDeploymentConfiguration" },
                                           { "Condition" : "InstallPublishConfiguration" }]},
    "InstallWebApplication" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "WebApplicationObject" }, "" ]}]},
    "InstallCalculationApplication" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "CalculationApplicationObject" }, "" ]}]},
    "InstallMongoDBApplication" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "MongoDBApplicationObject" }, "" ]}]},
    "InstallRabbitMQApplication" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "RabbitMQApplicationObject" }, "" ]}]},
    "InstallDataStagingApplication" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "DataStagingApplicationObject" }, "" ]}]},
    "InstallLoggingApplication" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "LoggingApplicationObject" }, "" ]}]},
    "InstallDeploymentApplication" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "DeploymentApplicationObject" }, "" ]}]},
    "InstallPublishApplication" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "PublishApplicationObject" }, "" ]}]},
    "InstallApplication" : { "Fn::Or" : [{ "Condition" : "InstallWebApplication" },
                                         { "Condition" : "InstallCalculationApplication" },
                                         { "Condition" : "InstallMongoDBApplication" },
                                         { "Condition" : "InstallRabbitMQApplication" },
                                         { "Condition" : "InstallDataStagingApplication" },
                                         { "Condition" : "InstallLoggingApplication" },
                                         { "Condition" : "InstallDeploymentApplication" },
                                         { "Condition" : "InstallPublishApplication" }]},
    "ConfigureLogs" : { "Fn::Not" : [{ "Fn::Equals" : [{ "Ref" : "LogRetention" }, "0" ]}]}
  },

  "Resources" : {
    "WebRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Principal" : { "Service" : [ "ec2.amazonaws.com" ]},
            "Action" : [ "sts:AssumeRole" ]
          }]
        },
        "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ]
      }
    },

    "CalculationRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Principal" : { "Service" : [ "ec2.amazonaws.com" ]},
            "Action" : [ "sts:AssumeRole" ]
          }]
        },
        "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ]
      }
    },

    "MongoDBRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Principal" : { "Service" : [ "ec2.amazonaws.com" ]},
            "Action" : [ "sts:AssumeRole" ]
          }]
        },
        "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ]
      }
    },

    "RabbitMQRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Principal" : { "Service" : [ "ec2.amazonaws.com" ]},
            "Action" : [ "sts:AssumeRole" ]
          }]
        },
        "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ]
      }
    },

    "DataStagingRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Principal" : { "Service" : [ "ec2.amazonaws.com" ]},
            "Action" : [ "sts:AssumeRole" ]
          }]
        },
        "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ]
      }
    },

    "LoggingRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Principal" : { "Service" : [ "ec2.amazonaws.com" ]},
            "Action" : [ "sts:AssumeRole" ]
          }]
        },
        "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ]
      }
    },

    "DeploymentRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Principal" : { "Service" : [ "ec2.amazonaws.com" ]},
            "Action" : [ "sts:AssumeRole" ]
          }]
        },
        "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ]
      }
    },

    "PublishRole" : {
      "Type" : "AWS::IAM::Role",
      "Properties" : {
        "Path" : "/",
        "AssumeRolePolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Principal" : { "Service" : [ "ec2.amazonaws.com" ]},
            "Action" : [ "sts:AssumeRole" ]
          }]
        },
        "ManagedPolicyArns" : [ "arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM" ]
      }
    },

    "DownloadProductFromS3Policy" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyName" : "DownloadProductFromS3Policy",
        "PolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Action" : [
              "s3:GetObject"
            ],
            "Resource" : { "Fn::Sub" : "arn:aws:s3:::${ProductsBucket}/${ProductFolder}/*" }
          }]
        },
        "Roles" : [
          { "Fn::If" : [ "InstallCalculationProduct", { "Ref" : "CalculationRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallMongoDBProduct", { "Ref" : "MongoDBRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallRabbitMQProduct", { "Ref" : "RabbitMQRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallDataStagingProduct", { "Ref" : "DataStagingRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallLoggingProduct", { "Ref" : "LoggingRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallDeploymentProduct", { "Ref" : "DeploymentRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallPublishProduct", { "Ref" : "PublishRole" }, { "Ref": "AWS::NoValue" }]}
        ]
      },
      "Condition" : "InstallProduct"
    },

    "DownloadConfigurationFromS3Policy" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyName" : "DownloadConfigurationFromS3Policy",
        "PolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Action" : [
              "s3:GetObject"
            ],
            "Resource" : { "Fn::Sub" : "arn:aws:s3:::${ConfigurationsBucket}/${ConfigurationFolder}/*" }
          }]
        },
        "Roles" : [
          { "Fn::If" : [ "InstallWebConfiguration", { "Ref" : "WebRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallCalculationConfiguration", { "Ref" : "CalculationRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallMongoDBConfiguration", { "Ref" : "MongoDBRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallRabbitMQConfiguration", { "Ref" : "RabbitMQRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallDataStagingConfiguration", { "Ref" : "DataStagingRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallLoggingConfiguration", { "Ref" : "LoggingRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallDeploymentConfiguration", { "Ref" : "DeploymentRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallPublishConfiguration", { "Ref" : "PublishRole" }, { "Ref": "AWS::NoValue" }]}
        ]
      },
      "Condition" : "InstallConfiguration"
    },

    "DownloadApplicationFromS3Policy" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyName" : "DownloadApplicationFromS3Policy",
        "PolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Action" : [
              "s3:GetObject"
            ],
            "Resource" : { "Fn::Sub" : "arn:aws:s3:::${ApplicationsBucket}/${ApplicationFolder}/*" }
          }]
        },
        "Roles" : [
          { "Fn::If" : [ "InstallWebApplication", { "Ref" : "WebRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallCalculationApplication", { "Ref" : "CalculationRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallMongoDBApplication", { "Ref" : "MongoDBRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallRabbitMQApplication", { "Ref" : "RabbitMQRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallDataStagingApplication", { "Ref" : "DataStagingRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallLoggingApplication", { "Ref" : "LoggingRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallDeploymentApplication", { "Ref" : "DeploymentRole" }, { "Ref": "AWS::NoValue" }]},
          { "Fn::If" : [ "InstallPublishApplication", { "Ref" : "PublishRole" }, { "Ref": "AWS::NoValue" }]}
        ]
      },
      "Condition" : "InstallApplication"
    },

    "LogMonitoringPolicy" : {
      "Type" : "AWS::IAM::Policy",
      "Properties" : {
        "PolicyName" : "LogMonitoringPolicy",
        "PolicyDocument" : {
          "Version" : "2012-10-17",
          "Statement" : [{
            "Effect" : "Allow",
            "Action" : [
              "logs:CreateLogGroup",
              "logs:CreateLogStream",
              "logs:PutLogEvents",
              "logs:DescribeLogStreams"
            ],
            "Resource" : "arn:aws:logs:*:*:*"
          }]
        },
        "Roles" : [
          { "Ref" : "WebRole" },
          { "Ref" : "CalculationRole" },
          { "Ref" : "MongoDBRole" },
          { "Ref" : "RabbitMQRole" },
          { "Ref" : "DataStagingRole" },
          { "Ref" : "LoggingRole" },
          { "Ref" : "DeploymentRole" },
          { "Ref" : "PublishRole" }
        ]
      },
      "Condition" : "ConfigureLogs"
    }
  },

  "Outputs" : {
    "WebRole" : {
      "Description" : "The WebRole",
      "Value" : { "Ref" : "WebRole" }
    },

    "CalculationRole" : {
      "Description" : "The CalculationRole",
      "Value" : { "Ref" : "CalculationRole" }
    },

    "MongoDBRole" : {
      "Description" : "The MongoDBRole",
      "Value" : { "Ref" : "MongoDBRole" }
    },

    "RabbitMQRole" : {
      "Description" : "The RabbitMQRole",
      "Value" : { "Ref" : "RabbitMQRole" }
    },

    "DataStagingRole" : {
      "Description" : "The DataStagingRole",
      "Value" : { "Ref" : "DataStagingRole" }
    },

    "LoggingRole" : {
      "Description" : "The LoggingRole",
      "Value" : { "Ref" : "LoggingRole" }
    },

    "DeploymentRole" : {
      "Description" : "The DeploymentRole",
      "Value" : { "Ref" : "DeploymentRole" }
    },

    "PublishRole" : {
      "Description" : "The PublishRole",
      "Value" : { "Ref" : "PublishRole" }
    }
  }
}
