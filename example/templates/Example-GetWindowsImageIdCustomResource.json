{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Example-GetWindowsImageIdCustomResource Template. This demonstrates how to dynamically get the most recent Windows ImageId, given the Windows OS Variant and Region. This template provisions an EC2 instance with an AMI ID that is based on the selected InstanceType, Windows OS Variant and Region.",

  "Parameters" : {
    "InstanceType" : {
      "Description" : "EC2 instance type",
      "Type" : "String",
      "Default" : "t2.medium",
      "AllowedValues" : [ "t2.micro", "t2.small", "t2.medium" ],
      "ConstraintDescription" : "Must be a valid EC2 instance type."
    },

    "WindowsVersion" : {
      "Description" : "Windows Version",
      "Type" : "String",
      "Default" : "Windows Server 2012 R2",
      "AllowedValues" : [
        "Windows Server 2016",
        "Windows Server 2016 with Containers",
        "Windows Server 2016 Nano",
        "Windows Server 2016 with SQL Server 2016 Express",
        "Windows Server 2016 with SQL Server 2016 Web",
        "Windows Server 2016 with SQL Server Standard",
        "Windows Server 2012 R2",
        "Windows Server 2012 R2 with SQL Server 2016 Express",
        "Windows Server 2012 R2 with SQL Server 2016 Web",
        "Windows Server 2012 R2 with SQL Server 2016 Standard",
        "Windows Server 2012 R2 with SQL Server 2014 Express",
        "Windows Server 2012 R2 with SQL Server 2014 Web",
        "Windows Server 2012 R2 with SQL Server 2014 Standard"
      ],
      "ConstraintDescription" : "Must be a valid Windows version."
    }
  },

  "Resources" : {
    "GetWindowsImageId" : {
      "Type" : "Custom::GetWindowsImageId",
      "Properties" : {
        "ServiceToken" : { "Fn::Sub" : "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:GetWindowsImageId" },
        "Region" : { "Ref" : "AWS::Region" },
        "OSName" : { "Ref" : "WindowsVersion" }
      }
    },

    "Instance" : {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "InstanceType" : { "Ref" : "InstanceType" },
        "ImageId" : { "Fn::GetAtt" : [ "GetWindowsImageId", "ImageId" ]}
      }
    },

  },

  "Outputs" : {
    "ImageId" : {
      "Description" : "The ImageId",
      "Value" : { "Fn::GetAtt" : [ "GetWindowsImageId", "ImageId" ]}
    },

    "Name" : {
      "Description" : "The Image Name",
      "Value" : { "Fn::GetAtt" : [ "GetWindowsImageId", "Name" ]}
    }
  }
}
