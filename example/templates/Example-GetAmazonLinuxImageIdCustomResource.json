{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Example-GetAmazonLinuxImageIdCustomResource Template. This demonstrates how to dynamically get the most recent Amazon Linux ImageId, given the Region. This template provisions an EC2 instance with an AMI ID that is based on the selected InstanceType and Region.",

  "Parameters" : {
    "InstanceType" : {
      "Description" : "EC2 instance type",
      "Type" : "String",
      "Default" : "t2.nano",
      "AllowedValues" : [ "t2.nano", "t2.micro", "t2.small", "t2.medium" ],
      "ConstraintDescription" : "Must be a valid EC2 instance type."
    },

    "AmazonLinuxVersion" : {
      "Description" : "Amazon Linux Version",
      "Type" : "String",
      "Default" : "Amazon Linux",
      "AllowedValues" : [
        "Amazon Linux",
        "Amazon Linux 2017.03.0",
        "Amazon Linux 2016.09.1",
        "Amazon Linux 2016.09.0"
      ],
      "ConstraintDescription" : "Must be a valid Amazon Linux version."
    }
  },

  "Resources" : {
    "GetAmazonLinuxImageIdOld" : {
      "Type" : "Custom::GetAmazonLinuxImageIdOld",
      "Properties" : {
        "ServiceToken" : { "Fn::Sub" : "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:GetAmazonLinuxImageId" },
        "Region" : { "Ref" : "AWS::Region" },
        "Architecture" : "HVM64"
      }
    },

    "InstanceOld" : {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "InstanceType"   : { "Ref" : "InstanceType" },
        "ImageId" : { "Fn::GetAtt" : [ "GetAmazonLinuxImageIdOld", "ImageId" ]}
      }
    },

    "GetAmazonLinuxImageId" : {
      "Type" : "Custom::GetAmazonLinuxImageId",
      "Properties" : {
        "ServiceToken" : { "Fn::Sub" : "arn:aws:lambda:${AWS::Region}:${AWS::AccountId}:function:GetAmazonLinuxImageId" },
        "Region" : { "Ref" : "AWS::Region" },
        "OSName" : { "Ref" : "AmazonLinuxVersion" }
      }
    },

    "Instance" : {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "InstanceType"   : { "Ref" : "InstanceType" },
        "ImageId" : { "Fn::GetAtt" : [ "GetAmazonLinuxImageId", "ImageId" ]}
      }
    }
  },

  "Outputs" : {
    "OldImageId" : {
      "Description" : "The Old ImageId",
      "Value" : { "Fn::GetAtt" : [ "GetAmazonLinuxImageIdOld", "ImageId" ]}
    },

    "OldName" : {
      "Description" : "The Old Image Name",
      "Value" : { "Fn::GetAtt" : [ "GetAmazonLinuxImageIdOld", "Name" ]}
    },

    "ImageId" : {
      "Description" : "The ImageId",
      "Value" : { "Fn::GetAtt" : [ "GetAmazonLinuxImageId", "ImageId" ]}
    },

    "Name" : {
      "Description" : "The Image Name",
      "Value" : { "Fn::GetAtt" : [ "GetAmazonLinuxImageId", "Name" ]}
    }
  }
}
